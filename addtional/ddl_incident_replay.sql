-- ddl_incident_replay.sql

-- 1) Core normalized event table
CREATE TABLE AD_EVENT_LOG (
  EVENT_LOG_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  EVENT_RECORD_ID   VARCHAR2(200),
  EVENT_ID          NUMBER,
  EVENT_TIME_RAW    VARCHAR2(4000),
  EVENT_TIME        TIMESTAMP,   -- optional; populate with TO_TIMESTAMP if format known
  COMPUTER          VARCHAR2(256),
  ACCOUNT_NAME      VARCHAR2(256),
  SUBJECT_USERNAME  VARCHAR2(256),
  TARGET_USERNAME   VARCHAR2(256),
  TARGET_USER_SID   VARCHAR2(256),
  IP_ADDRESS        VARCHAR2(128),
  IP_PORT           VARCHAR2(32),
  PROCESS_NAME      VARCHAR2(1024),
  PROCESS_ID        VARCHAR2(64),
  EVTX_FILENAME     VARCHAR2(256),
  EVTX_TACTIC       VARCHAR2(128),
  AUTH_PACKAGE      VARCHAR2(128),
  RAW_EVENT_JSON    CLOB,
  CREATED_AT        TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- 2) Raw CSV store (one raw row per import)
CREATE TABLE AD_RAW_EVENTS (
  RAW_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  CSV_ROW CLOB,
  LOADED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- 3) Incident meta table
CREATE TABLE INCIDENTS (
  INCIDENT_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
  START_TIME TIMESTAMP,
  END_TIME TIMESTAMP,
  TITLE VARCHAR2(400),
  DESCRIPTION CLOB,
  SEVERITY VARCHAR2(20),
  EVENT_COUNT NUMBER DEFAULT 0
);

-- 4) Incident <-> events link
CREATE TABLE INCIDENT_EVENTS (
  INCIDENT_EVENT_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  INCIDENT_ID NUMBER REFERENCES INCIDENTS(INCIDENT_ID),
  EVENT_LOG_ID NUMBER REFERENCES AD_EVENT_LOG(EVENT_LOG_ID),
  EVENT_TIME TIMESTAMP,
  SEQ_NO NUMBER
);

-- 5) Alerts table (optional)
CREATE TABLE ALERTS (
  ALERT_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  ALERT_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
  ALERT_TYPE VARCHAR2(100),
  SEVERITY VARCHAR2(20),
  DESCRIPTION CLOB,
  INCIDENT_ID NUMBER
);

-- Indexes
CREATE INDEX IDX_AD_EVENT_TIME ON AD_EVENT_LOG(EVENT_TIME);
CREATE INDEX IDX_AD_EVENT_ACCOUNT ON AD_EVENT_LOG(ACCOUNT_NAME);
CREATE INDEX IDX_AD_EVENT_IP ON AD_EVENT_LOG(IP_ADDRESS);
CREATE INDEX IDX_INCIDENT_EVENTS_INCIDENT ON INCIDENT_EVENTS(INCIDENT_ID);

COMMIT;
