{% extends 'base.html' %}
{% block title %}IP: {{ ip }} - AD Security{% endblock %}
{% block content %}

<div class="animate-fadeInUp">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/alerts">Alerts</a></li>
      <li class="breadcrumb-item active" aria-current="page">IP Investigation</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="mb-4">
    <h1 class="mb-2">
      <i class="fas fa-network-wired me-2" style="color: var(--accent-primary);"></i>
      IP Address Investigation
    </h1>
    <p class="text-secondary mb-0">
      Analyzing security alerts for IP: <span class="text-primary fw-bold">{{ ip }}</span>
    </p>
  </div>

  <!-- Summary Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="stat-card danger">
        <div class="stat-label">Total Alerts</div>
        <div class="stat-value" style="font-size: 2rem; background: linear-gradient(135deg, #ff5e57, #ff3838); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          {{ rows|length }}
        </div>
        <small class="text-secondary">Security incidents detected</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Affected Hosts</div>
        <div class="stat-value" style="font-size: 2rem;">
          {{ rows|map(attribute=7)|unique|list|length }}
        </div>
        <small class="text-secondary">Unique computers targeted</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card warning">
        <div class="stat-label">Critical Alerts</div>
        <div class="stat-value" style="font-size: 2rem;">
          {{ rows|selectattr('2', 'equalto', 'CRITICAL')|list|length }}
        </div>
        <small class="text-secondary">High priority threats</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card success">
        <div class="stat-label">Avg Risk Score</div>
        <div class="stat-value" style="font-size: 2rem;">
          {% if rows %}
            {{ (rows|map(attribute=4)|sum / rows|length)|round|int }}
          {% else %}
            0
          {% endif %}
        </div>
        <small class="text-secondary">Threat severity level</small>
      </div>
    </div>
  </div>

  <!-- IP Information Card -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-info-circle me-2"></i>IP Address Information
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <h6 class="text-secondary">IP Address</h6>
          <p class="h4 text-primary">{{ ip }}</p>
        </div>
        <div class="col-md-4">
          <h6 class="text-secondary">Status</h6>
          <p>
            {% if rows|length > 5 %}
              <span class="badge bg-critical">
                <i class="fas fa-ban me-1"></i>Blocked
              </span>
            {% else %}
              <span class="badge bg-warning">
                <i class="fas fa-eye me-1"></i>Monitored
              </span>
            {% endif %}
          </p>
        </div>
        <div class="col-md-4">
          <h6 class="text-secondary">Threat Classification</h6>
          <p>
            {% if rows|selectattr('2', 'equalto', 'CRITICAL')|list|length > 0 %}
              <span class="badge bg-critical">Critical Threat</span>
            {% elif rows|selectattr('2', 'equalto', 'HIGH')|list|length > 0 %}
              <span class="badge bg-high">High Risk</span>
            {% else %}
              <span class="badge bg-medium">Medium Risk</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex gap-3 mb-4">
    <a href="/alerts" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Alerts
    </a>
    <button class="btn btn-danger">
      <i class="fas fa-ban me-2"></i>Block IP
    </button>
    <button class="btn btn-warning">
      <i class="fas fa-eye-slash me-2"></i>Add to Watchlist
    </button>
    <button class="btn btn-primary" onclick="exportIPData()">
      <i class="fas fa-download me-2"></i>Export Report
    </button>
  </div>

  <!-- Affected Hosts Card -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-server me-2"></i>Affected Hosts
    </div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        {% for host in rows|map(attribute=7)|unique %}
        <a href="/host/{{ host }}" class="btn btn-outline-light">
          <i class="fas fa-server me-2"></i>{{ host }}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Alerts Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>
        <i class="fas fa-list me-2"></i>Security Alerts from {{ ip }}
      </span>
      <span class="badge bg-danger">{{ rows|length }} Total</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="ipAlertsTable">
        <thead>
          <tr>
            <th>Alert ID</th>
            <th>Time</th>
            <th>Host</th>
            <th class="text-center">Severity</th>
            <th class="text-center">Risk</th>
            <th>Category</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in rows %}
          <tr>
            <!-- Alert ID -->
            <td>
              <a class="fw-bold text-decoration-none" style="color: var(--accent-primary);" href="/event/{{ a[6] }}">
                #{{ a[0] }}
              </a>
            </td>

            <!-- Time -->
            <td>
              <small>{{ a[1] }}</small>
            </td>

            <!-- Host -->
            <td>
              <a href="/host/{{ a[7] }}" class="text-decoration-none" style="color: var(--accent-primary);">
                <i class="fas fa-server me-1"></i>{{ a[7] }}
              </a>
            </td>

            <!-- Severity -->
            <td class="text-center">
              {% if a[2] == 'CRITICAL' %}
                <span class="badge bg-critical">
                  <i class="fas fa-skull-crossbones me-1"></i>{{ a[2] }}
                </span>
              {% elif a[2] == 'HIGH' %}
                <span class="badge bg-high">
                  <i class="fas fa-exclamation-triangle me-1"></i>{{ a[2] }}
                </span>
              {% elif a[2] == 'MEDIUM' %}
                <span class="badge bg-medium">
                  <i class="fas fa-info-circle me-1"></i>{{ a[2] }}
                </span>
              {% else %}
                <span class="badge bg-low">
                  <i class="fas fa-check-circle me-1"></i>{{ a[2] }}
                </span>
              {% endif %}
            </td>

            <!-- Risk -->
            <td class="text-center">
              <span class="badge
                {% if a[5] == 'CRITICAL' %} bg-critical
                {% elif a[5] == 'HIGH' %} bg-high
                {% elif a[5] == 'MEDIUM' %} bg-medium
                {% else %} bg-low {% endif %}">
                {{ a[5] }} ({{ a[4] }})
              </span>
            </td>

            <!-- Category -->
            <td>
              <span class="badge bg-info text-dark">
                <i class="fas fa-tag me-1"></i>{{ a[3] }}
              </span>
            </td>

            <!-- Actions -->
            <td class="text-end">
              <a href="/event/{{ a[6] }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-eye me-1"></i>View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Activity Timeline -->
  <div class="card mt-4">
    <div class="card-header">
      <i class="fas fa-chart-line me-2"></i>Attack Timeline
    </div>
    <div class="card-body">
      <canvas id="activityTimeline" height="80"></canvas>
    </div>
  </div>

  <!-- Security Analysis -->
  <div class="card mt-4">
    <div class="card-header bg-danger">
      <i class="fas fa-shield-alt me-2"></i>Security Analysis
    </div>
    <div class="card-body">
      <div class="alert alert-danger">
        <h5 class="alert-heading">
          <i class="fas fa-exclamation-triangle me-2"></i>Threat Assessment
        </h5>
        <p>This IP address has been flagged for suspicious activity across multiple hosts in your network.</p>
        <hr>
        <p class="mb-0">
          <strong>Recommendation:</strong> Block this IP at the firewall level and investigate all affected hosts for compromise.
        </p>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <h6 class="text-primary"><i class="fas fa-clipboard-list me-2"></i>Observed Behaviors:</h6>
          <ul>
            <li>Multiple failed authentication attempts</li>
            <li>Lateral movement indicators</li>
            <li>Privilege escalation attempts</li>
            <li>Data exfiltration patterns</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Recommended Actions:</h6>
          <ul>
            <li>Block IP address immediately</li>
            <li>Reset credentials on affected hosts</li>
            <li>Review firewall rules</li>
            <li>Enable enhanced monitoring</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Export IP data
  function exportIPData() {
    const table = document.getElementById('ipAlertsTable');
    let csv = [];
    
    // Headers
    const headers = ['IP Address', '{{ ip }}', '', '', '', '', ''];
    csv.push(headers.join(','));
    csv.push('');
    
    // Table headers
    const tableHeaders = [];
    table.querySelectorAll('thead th').forEach(th => {
      tableHeaders.push(th.textContent.trim());
    });
    csv.push(tableHeaders.join(','));
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(row => {
      const cols = [];
      row.querySelectorAll('td').forEach(td => {
        cols.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
      });
      csv.push(cols.join(','));
    });
    
    // Download
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ip_{{ ip }}_report_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }

  // Create activity timeline chart
  Chart.defaults.color = '#a0a4b8';
  Chart.defaults.borderColor = '#2d3561';

  const alertTimes = {{ rows|map(attribute=1)|list|tojson|safe }};
  const riskScores = {{ rows|map(attribute=4)|list|tojson|safe }};

  new Chart(document.getElementById('activityTimeline'), {
    type: 'line',
    data: {
      labels: alertTimes,
      datasets: [{
        label: 'Risk Score Over Time',
        data: riskScores,
        borderColor: 'rgba(255, 94, 87, 1)',
        backgroundColor: 'rgba(255, 94, 87, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'rgba(255, 94, 87, 1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26, 31, 58, 0.95)',
          padding: 12,
          displayColors: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#2d3561' },
          ticks: { font: { size: 11 } },
          title: {
            display: true,
            text: 'Risk Score'
          }
        },
        x: {
          grid: { display: false },
          ticks: { 
            font: { size: 9 },
            maxRotation: 45,
            minRotation: 45
          },
          title: {
            display: true,
            text: 'Time'
          }
        }
      }
    }
  });
</script>
{% endblock %}