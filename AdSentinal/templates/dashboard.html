{% extends 'base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-6">Command Center</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-dark-card border border-dark-700 p-6 rounded-xl hover:border-brand-500 transition-colors">
            <div class="flex justify-between mb-2">
                <span class="text-slate-400 text-xs font-bold uppercase">Total Events</span>
                <i class="ph ph-database text-brand-500 text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-white">{{ "{:,}".format(total_events) }}</div>
        </div>
        <div class="bg-dark-card border border-dark-700 p-6 rounded-xl hover:border-risk-crit transition-colors">
            <div class="flex justify-between mb-2">
                <span class="text-risk-crit text-xs font-bold uppercase">Active Alerts</span>
                <i class="ph-fill ph-siren text-risk-crit text-xl animate-pulse"></i>
            </div>
            <div class="text-3xl font-bold text-risk-crit">{{ "{:,}".format(total_alerts) }}</div>
        </div>
        <div class="bg-dark-card border border-dark-700 p-6 rounded-xl hover:border-risk-high transition-colors">
            <div class="flex justify-between mb-2">
                <span class="text-slate-400 text-xs font-bold uppercase">Critical Hosts</span>
                <i class="ph ph-desktop text-risk-high text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-white">{{ top_hosts|length }}</div>
        </div>
        <div class="bg-dark-card border border-dark-700 p-6 rounded-xl hover:border-risk-low transition-colors">
            <div class="flex justify-between mb-2">
                <span class="text-slate-400 text-xs font-bold uppercase">Detection Rate</span>
                <i class="ph ph-heartbeat text-risk-low text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-risk-low">
                {% if total_events > 0 %}{{ "%.1f"|format((total_alerts / total_events * 100)) }}%{% else %}0%{% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 bg-dark-card border border-dark-700 rounded-xl p-6">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="ph ph-globe"></i> Global Threat Map</h3>
            <div id="world-map" style="width: 100%; height: 350px;"></div>
        </div>

        <div class="bg-dark-card border border-dark-700 rounded-xl p-6">
            <h3 class="text-white font-bold mb-4">Risk Distribution</h3>
            <div class="relative h-64"><canvas id="riskChart"></canvas></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-dark-card border border-dark-700 rounded-xl p-6">
            <h3 class="text-white font-bold mb-4">Alert Categories</h3>
            <div class="relative h-64"><canvas id="catChart"></canvas></div>
        </div>

        <div class="lg:col-span-2 bg-dark-card border border-dark-700 rounded-xl overflow-hidden">
            <div class="p-6 border-b border-dark-700"><h3 class="text-white font-bold">Top Targeted Hosts</h3></div>
            <table class="w-full text-left text-sm text-slate-400">
                <thead class="bg-dark-900 text-xs uppercase font-bold text-slate-500">
                    <tr><th class="px-6 py-3">Host</th><th class="px-6 py-3">Alerts</th><th class="px-6 py-3 text-right">Action</th></tr>
                </thead>
                <tbody class="divide-y divide-dark-700">
                    {% for h in top_hosts %}
                    <tr class="hover:bg-dark-800 transition-colors">
                        <td class="px-6 py-3 font-medium text-white">
                            <a href="/host/{{ h[0] }}" class="hover:text-brand-500 hover:underline flex items-center gap-2">
                                <i class="ph ph-desktop"></i> {{ h[0] }}
                            </a>
                        </td>
                        <td class="px-6 py-3">{{ h[1] }}</td>
                        <td class="px-6 py-3 text-right">
                            <a href="/host/{{ h[0] }}" class="text-xs font-bold text-brand-500 uppercase hover:underline">Inspect</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    // 1. Initialize Map
    const map = new jsVectorMap({
        selector: "#world-map",
        map: "world",
        backgroundColor: "transparent",
        zoomButtons: false,
        regionStyle: { initial: { fill: "#334155" }, hover: { fill: "#6366f1" } },
        markers: [
            { name: "DC-01 (US)", coords: [38.90, -77.03] },
            { name: "DC-02 (EU)", coords: [52.52, 13.40] },
            { name: "Threat Source", coords: [35.68, 139.69], style: { fill: '#f43f5e' } }
        ],
        markerStyle: { initial: { fill: "#6366f1", stroke: "#1e293b", strokeWidth: 2 } }
    });

    // 2. Risk Chart
    new Chart(document.getElementById('riskChart'), {
        type: 'bar',
        data: {
            labels: {{ alerts_by_risk|map(attribute=0)|list|tojson|safe }},
            datasets: [{
                label: 'Count',
                data: {{ alerts_by_risk|map(attribute=1)|list|tojson|safe }},
                backgroundColor: ['#f43f5e', '#f97316', '#eab308', '#10b981'],
                borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#334155' } } } }
    });

    // 3. Category Chart
    new Chart(document.getElementById('catChart'), {
        type: 'doughnut',
        data: {
            labels: {{ alerts_by_cat|map(attribute=0)|list|tojson|safe }},
            datasets: [{
                data: {{ alerts_by_cat|map(attribute=1)|list|tojson|safe }},
                backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } } } }
    });
</script>
{% endblock %}