{% extends 'base.html' %}
{% block title %}Statistics | AD Sentinel{% endblock %}
{% block content %}

<div class="space-y-8 animate-fadeInUp">

    <!-- Breadcrumb -->
    <div class="text-sm text-slate-400 flex items-center gap-2">
        <a href="/" class="hover:text-white">Home</a>
        <span>/</span>
        <span class="text-brand-500 font-semibold">Statistics</span>
    </div>

    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="ph ph-chart-line text-brand-500 text-2xl"></i>
                Daily Statistics
            </h1>
            <p class="text-slate-400 text-sm">Historical security metrics & detection trends</p>
        </div>
        <button onclick="exportStats()" class="px-4 py-2 bg-brand-600 hover:bg-brand-500 rounded-md flex items-center gap-2 text-sm font-semibold">
            <i class="ph ph-download"></i> Export Stats
        </button>
    </div>

    <!-- Summary Cards -->
    {% if rows %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

        <div class="stat-card">
            <p class="stat-label">Total Days Tracked</p>
            <p class="stat-value">{{ rows|length }}</p>
            <p class="text-slate-500 text-xs">Monitoring period</p>
        </div>

        <div class="stat-card danger">
            <p class="stat-label">Total Events</p>
            <p class="stat-value">{{ "{:,}".format(rows|map(attribute=1)|sum) }}</p>
            <p class="text-slate-500 text-xs">All-time system events</p>
        </div>

        <div class="stat-card warning">
            <p class="stat-label">Total Alerts</p>
            <p class="stat-value">{{ "{:,}".format(rows|map(attribute=2)|sum) }}</p>
            <p class="text-slate-500 text-xs">Security incidents detected</p>
        </div>

        <div class="stat-card success">
            <p class="stat-label">Avg Daily Alerts</p>
            <p class="stat-value">{{ (rows|map(attribute=2)|sum / rows|length)|round|int }}</p>
            <p class="text-slate-500 text-xs">Alerts per day</p>
        </div>

    </div>
    {% endif %}

    <!-- Main Trend Chart -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
            <i class="ph ph-chart-line-up text-slate-200"></i> Security Trend Over Time
        </h2>
        <div class="h-80">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <!-- Category Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i class="ph ph-arrow-elbow-down-right text-red-400"></i> Lateral Movement Activity
            </h2>
            <canvas id="lateralChart" class="h-72"></canvas>
        </div>

        <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i class="ph ph-shield-warning text-yellow-400"></i> Privilege Escalation Attempts
            </h2>
            <canvas id="privescChart" class="h-72"></canvas>
        </div>
    </div>

    <!-- Daily Stats Table -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b border-dark-700">
            <h2 class="text-base font-semibold flex items-center gap-2">
                <i class="ph ph-table"></i> Daily Security Statistics
            </h2>
            <span class="px-2 py-1 text-xs font-semibold bg-brand-600 rounded">{{ rows|length }} Days</span>
        </div>

        <div class="overflow-x-auto">
            <table id="statsTable" class="w-full text-sm">
                <thead class="bg-dark-700 text-slate-300">
                    <tr>
                        <th class="px-4 py-3 text-left">Date</th>
                        <th class="px-4 py-3 text-center">Total Events</th>
                        <th class="px-4 py-3 text-center">Total Alerts</th>
                        <th class="px-4 py-3 text-center">Lateral Movement</th>
                        <th class="px-4 py-3 text-center">Privilege Escalation</th>
                        <th class="px-4 py-3 text-left">Generated At</th>
                        <th class="px-4 py-3 text-center">Detection Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr class="border-b border-dark-700 hover:bg-dark-700">
                        <td class="px-4 py-3 font-semibold flex items-center gap-2">
                            <i class="ph ph-calendar"></i> {{ r[0] }}
                        </td>
                        <td class="px-4 py-3 text-center">{{ "{:,}".format(r[1]) }}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="badge-risk {{ r[2] }}">
                                {{ r[2] }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">{{ r[3] }}</td>
                        <td class="px-4 py-3 text-center">{{ r[4] }}</td>
                        <td class="px-4 py-3">{{ r[5] }}</td>
                        <td class="px-4 py-3 text-center">
                            {% set rate = (r[2] / r[1] * 100) if r[1] > 0 else 0 %}
                            <span class="badge-risk {{ rate }}">
                                {{ "%.2f"|format(rate) }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

{% endblock %}

{% block js %}
<script>
Chart.defaults.color = '#a0a4b8';
Chart.defaults.borderColor = '#2d3561';

const dates = {{ rows|map(attribute=0)|list|tojson|safe }};
const totalEvents = {{ rows|map(attribute=1)|list|tojson|safe }};
const totalAlerts = {{ rows|map(attribute=2)|list|tojson|safe }};
const lateralMovement = {{ rows|map(attribute=3)|list|tojson|safe }};
const privEsc = {{ rows|map(attribute=4)|list|tojson|safe }};

new Chart(document.getElementById('trendsChart'), {
  type: 'line',
  data: {
    labels: dates,
    datasets: [
      { label: 'Events', data: totalEvents, borderColor: '#00D4FF', backgroundColor: 'rgba(0,212,255,.1)', fill: true },
      { label: 'Alerts', data: totalAlerts, borderColor: '#FF5E57', backgroundColor: 'rgba(255,94,87,.1)', fill: true }
    ]
  }
});

new Chart(document.getElementById('lateralChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ data: lateralMovement, backgroundColor: '#FF5E57' }] }
});

new Chart(document.getElementById('privescChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ data: privEsc, backgroundColor: '#FECB57' }] }
});

function exportStats() {
  let rows = document.querySelectorAll('#statsTable tr');
  let csv = [];
  rows.forEach(r => csv.push([...r.children].map(td => `"${td.innerText}"`).join(',')));
  let file = new Blob([csv.join('\n')], { type: 'text/csv' });
  let url = URL.createObjectURL(file);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'security_statistics.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
{% endblock %}
