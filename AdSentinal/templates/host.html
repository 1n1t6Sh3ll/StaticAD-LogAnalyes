{% extends 'base.html' %}
{% block title %}Host: {{ hostname }} | AD Sentinel{% endblock %}
{% block content %}

<div class="animate-fadeInUp space-y-8">

    <!-- Breadcrumb -->
    <div class="text-sm text-slate-400 flex items-center gap-2">
        <a href="/" class="hover:text-white">Home</a>
        <span>/</span>
        <a href="/alerts" class="hover:text-white">Alerts</a>
        <span>/</span>
        <span class="text-brand-500 font-semibold">Host Investigation</span>
    </div>

    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold flex items-center gap-2">
            <i class="ph ph-device-desktop text-brand-500 text-2xl"></i>
            Host Investigation
        </h1>
        <p class="text-slate-400 text-sm">
            Analyzing alerts for host:
            <span class="text-brand-500 font-semibold">{{ hostname }}</span>
        </p>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
        <div class="bg-dark-800 rounded-xl border border-dark-700 p-5">
            <p class="text-slate-400 text-sm mb-1">Total Alerts</p>
            <p class="text-3xl font-bold bg-gradient-to-r from-red-400 to-red-600 bg-clip-text text-transparent">
                {{ rows|length }}
            </p>
            <p class="text-slate-500 text-xs">Security incidents detected</p>
        </div>
        <div class="bg-dark-800 rounded-xl border border-dark-700 p-5">
            <p class="text-slate-400 text-sm mb-1">Critical Alerts</p>
            <p class="text-3xl font-bold">
                {{ rows|selectattr('2', 'equalto', 'CRITICAL')|list|length }}
            </p>
            <p class="text-slate-500 text-xs">Requires immediate action</p>
        </div>
        <div class="bg-dark-800 rounded-xl border border-dark-700 p-5">
            <p class="text-slate-400 text-sm mb-1">High Alerts</p>
            <p class="text-3xl font-bold">
                {{ rows|selectattr('2', 'equalto', 'HIGH')|list|length }}
            </p>
            <p class="text-slate-500 text-xs">Needs investigation</p>
        </div>
        <div class="bg-dark-800 rounded-xl border border-dark-700 p-5">
            <p class="text-slate-400 text-sm mb-1">Threat Score</p>
            <p class="text-3xl font-bold">
                {% if rows %}{{ (rows|map(attribute=4)|sum / rows|length)|round|int }}{% else %}0{% endif %}
            </p>
            <p class="text-slate-500 text-xs">Average risk score</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-dark-800 p-5 rounded-xl border border-dark-700">
        <form method="GET" action="/host/{{ hostname }}" id="filterForm"
              class="grid grid-cols-1 md:grid-cols-3 gap-5">

            <!-- Severity -->
            <div>
                <label class="text-sm text-slate-300 mb-1 flex items-center gap-2">
                    <i class="ph ph-warning-circle"></i> Severity
                </label>
                <select name="severity"
                        class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm">
                    <option value="">All</option>
                    {% for s in severities %}
                    <option value="{{ s }}" {% if s == severity %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Category -->
            <div>
                <label class="text-sm text-slate-300 mb-1 flex items-center gap-2">
                    <i class="ph ph-tag"></i> Category
                </label>
                <select name="category"
                        class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm">
                    <option value="">All</option>
                    {% for c in categories %}
                    <option value="{{ c }}" {% if c == category %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

        </form>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll("#filterForm select").forEach(el =>
                    el.addEventListener("change", () => document.getElementById("filterForm").submit())
                );
            });
        </script>
    </div>

    <!-- Action buttons -->
    <div class="flex flex-wrap gap-3">
        <a href="/alerts"
           class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-md flex items-center gap-2 border border-dark-600">
            <i class="ph ph-arrow-left"></i> Back to Alerts
        </a>
        <button class="px-4 py-2 bg-risk-crit hover:bg-red-500 rounded-md flex items-center gap-2">
            <i class="ph ph-prohibit"></i> Isolate Host
        </button>
        <button class="px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-black rounded-md flex items-center gap-2">
            <i class="ph ph-shield-chevron"></i> Apply Patch
        </button>
        <button onclick="exportHostData()"
           class="px-4 py-2 bg-brand-600 hover:bg-brand-500 rounded-md flex items-center gap-2">
            <i class="ph ph-download"></i> Export Report
        </button>
    </div>

    <!-- Alerts Table -->
    <div class="bg-dark-800 rounded-xl border border-dark-700 overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3 border-b border-dark-700">
            <span class="font-semibold flex items-center gap-2">
                <i class="ph ph-warning"></i> Security Alerts for {{ hostname }}
            </span>
            <span class="px-2 py-1 bg-risk-crit text-white rounded text-xs font-semibold">
                {{ rows|length }} Total
            </span>
        </div>

        <table id="hostAlertsTable" class="w-full text-sm">
            <thead class="bg-dark-700 text-slate-300">
                <tr>
                    <th class="px-4 py-3 text-left">Alert ID</th>
                    <th class="px-4 py-3 text-left">Time</th>
                    <th class="px-4 py-3 text-center">Severity</th>
                    <th class="px-4 py-3 text-center">Risk</th>
                    <th class="px-4 py-3 text-left">Category</th>
                    <th class="px-4 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in rows %}
                <tr class="border-b border-dark-700 hover:bg-dark-700">
                    <td class="px-4 py-3">
                        <a href="/event/{{ a[6] }}" class="text-brand-500 hover:underline font-semibold">#{{ a[0] }}</a>
                    </td>
                    <td class="px-4 py-3"><small>{{ a[1] }}</small></td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded font-bold
                        {% if a[2]=='CRITICAL' %} bg-risk-crit
                        {% elif a[2]=='HIGH' %} bg-risk-high
                        {% elif a[2]=='MEDIUM' %} bg-risk-med
                        {% else %} bg-risk-low {% endif %}">
                        {{ a[2] }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded font-bold
                        {% if a[5]=='CRITICAL' %} bg-risk-crit
                        {% elif a[5]=='HIGH' %} bg-risk-high
                        {% elif a[5]=='MEDIUM' %} bg-risk-med
                        {% else %} bg-risk-low {% endif %}">
                        {{ a[5] }} ({{ a[4] }})
                        </span>
                    </td>
                    <td class="px-4 py-3">{{ a[3] }}</td>
                    <td class="px-4 py-3 text-right">
                        <a href="/event/{{ a[6] }}" class="px-3 py-1 bg-dark-600 hover:bg-dark-500 rounded-md text-xs font-semibold">
                            <i class="ph ph-eye mr-1"></i> Investigate
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Threat Timeline -->
    <div class="bg-dark-800 rounded-xl border border-dark-700 p-6">
        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
            <i class="ph ph-chart-line"></i> Threat Timeline Analysis
        </h2>
        <div class="h-72">
            <canvas id="threatTimeline"></canvas>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="bg-dark-800 rounded-xl border border-dark-700 p-6 space-y-6">
        <h2 class="text-lg font-semibold flex items-center gap-2">
            <i class="ph ph-warning text-yellow-300"></i> Security Recommendations
        </h2>

        <div class="p-4 rounded-md bg-[rgba(255,0,0,0.1)] border border-risk-crit">
            <p class="text-sm text-red-400 font-semibold mb-1">
                <i class="ph ph-shield-warning"></i> Critical Action Required
            </p>
            <p class="text-slate-300 text-sm">This host has been identified as a high-risk target. Immediate remediation is advised.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div>
                <p class="text-brand-500 font-semibold flex items-center gap-2 mb-2">
                    <i class="ph ph-check-circle"></i> Immediate Steps
                </p>
                <ul class="text-sm text-slate-300 space-y-1">
                    <li>Isolate the host from network</li>
                    <li>Review user access logs</li>
                    <li>Check for unauthorized software</li>
                    <li>Scan for malware & rootkits</li>
                    <li>Reset all user passwords</li>
                </ul>
            </div>

            <div>
                <p class="text-yellow-300 font-semibold flex items-center gap-2 mb-2">
                    <i class="ph ph-lock"></i> Long-term Security
                </p>
                <ul class="text-sm text-slate-300 space-y-1">
                    <li>Enable advanced threat protection</li>
                    <li>Implement strict access controls</li>
                    <li>Regular security audits</li>
                    <li>Update security policies</li>
                    <li>Cybersecurity training for users</li>
                </ul>
            </div>

        </div>
    </div>

</div>

{% endblock %}

{% block js %}
<script>
function exportHostData() {
    exportTable('hostAlertsTable', 'host_{{ hostname }}_report.csv');
}

const alertTimes = {{ rows|map(attribute=1)|list|tojson|safe }};
const riskScores = {{ rows|map(attribute=4)|list|tojson|safe }};

new Chart(document.getElementById('threatTimeline'), {
    type: 'line',
    data: {
        labels: alertTimes,
        datasets: [{
            label: "Risk Score",
            data: riskScores,
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { display: false }},
            y: { beginAtZero: true }
        }
    }
});
</script>
{% endblock %}
